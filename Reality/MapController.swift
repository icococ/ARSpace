//
//  MapController.swift
//  Reality
//
//  Created by Feng Wang on 11/4/20.
//

import ARKit

struct MapController {
    private static let mapSaveURL: URL = {
        do {
            return try FileManager.default
                .url(for: .documentDirectory,
                     in: .userDomainMask,
                     appropriateFor: nil,
                     create: true)
                .appendingPathComponent("map.arexperience")
        } catch {
            fatalError("Can't get file save URL: \(error.localizedDescription)")
        }
    }()
    
    private static let mapDataFromFile: Data? = {
        return try? Data(contentsOf: mapSaveURL)
    }()
    
    static func loadSnapshot() -> UIImage?  {
        let worldMap: ARWorldMap? = {
            guard let data = mapDataFromFile else {
                return nil
//                fatalError("Map data should already be verified to exist before Load button is enabled.")
            }
            do {
                guard let worldMap = try NSKeyedUnarchiver.unarchivedObject(ofClass: ARWorldMap.self, from: data)
                    else { fatalError("No ARWorldMap in archive.") }
                return worldMap
            } catch {
                fatalError("Can't unarchive ARWorldMap from file data: \(error)")
            }
        }()
        
        // Display the snapshot image stored in the world map to aid user in relocalizing.
        if let snapshotData = worldMap?.snapshotAnchor?.imageData,
            let snapshot = UIImage(data: snapshotData) {
            return snapshot
        } else {
            print("No snapshot image in world map")
            return nil
        }
    }
}

